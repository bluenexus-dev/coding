<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blue Nexus | Coding</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;700&display=swap" rel="stylesheet">
  <link rel="icon" href="images/favicons/favicon.coding.png" type="image/png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>

  <style>
    :root {
      --main-bg: #2c2c2c;
      --side-bg: #3a3a3a;
      --header-bg: #141414;
      --footer-bg: #141414;
      --text-color: #ffffff;
      --coding-color: #188038;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Poppins', sans-serif;
      background-color: var(--side-bg);
      color: var(--text-color);
    }

    .main-content {
      width: 60%;
      margin: 0 auto;
      background-color: var(--main-bg);
      padding: 2rem 0;
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
      min-height: calc(100vh - 220px - 6rem);
    }

    header.main-header {
      background-color: var(--header-bg);
      height: 220px;
      display: flex;
      align-items: center;
      position: relative;
    }

    .header-logo {
      height: 180px;
      width: auto;
      position: absolute;
      left: 20%;
    }

    footer.main-footer {
      background-color: var(--footer-bg);
      text-align: center;
      padding: 2rem 0;
    }

    .back-button, .save-button, .load-button {
      position: absolute;
      top: 24px;
      background-color: var(--coding-color);
      color: #fff;
      border: none;
      padding: 10px 18px;
      font-weight: bold;
      border-radius: 8px;
      cursor: pointer;
      transition: opacity 0.3s ease;
    }

    .back-button:hover, .save-button:hover, .load-button:hover {
      opacity: 0.85;
    }

    .back-button {
      right: 48px;
    }

    .save-button {
      right: 240px;
    }

    .load-button {
      right: 150px;
    }

    .side-panel {
      position: absolute;
      top: 220px;
      width: 20%;
      background-color: var(--side-bg);
      padding: 0.8rem;
      border: 2px solid var(--coding-color);
      min-height: calc(100vh - 220px);
    }

    .side-panel.left {
      left: 0;
    }

    .side-panel.right {
      right: 0;
    }

    .side-panel h3 {
      color: var(--coding-color);
      margin-top: 0;
      text-align: center;
      border-bottom: 2px solid var(--coding-color);
      padding-bottom: 0.4rem;
      font-size: 0.85rem;
    }

    .glyph-item, .macro-item {
      background: #141414;
      padding: 0.25rem;
      margin: 0.25rem 0;
      border-radius: 6px;
      font-size: 0.65rem;
      cursor: pointer;
      transition: opacity 0.3s ease;
      text-align: center;
    }

    .glyph-item:hover, .macro-item:hover {
      opacity: 0.8;
    }

    .glyph-char {
      color: var(--coding-color);
      font-weight: bold;
      font-size: 1rem;
      display: block;
      margin-bottom: 0.1rem;
    }

    .add-macro-btn {
      background: var(--coding-color);
      color: #fff;
      border: none;
      padding: 0.35rem;
      border-radius: 6px;
      cursor: pointer;
      width: 100%;
      font-weight: bold;
      margin-top: 0.4rem;
      transition: opacity 0.3s ease;
      font-family: 'Poppins', sans-serif;
      font-size: 0.75rem;
    }

    .add-macro-btn:hover {
      opacity: 0.85;
    }

    .code-area {
      width: 90%;
      margin: 1rem auto;
      display: block;
    }

    .CodeMirror {
      height: 400px;
      font-family: 'Courier New', monospace;
      font-size: 1rem;
      border: 2px solid var(--coding-color);
      border-radius: 8px;
    }

    .console-section {
      width: 90%;
      margin: 1rem auto;
    }

    .console-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .console-header h3 {
      color: var(--coding-color);
      margin: 0;
    }

    .run-button {
      background-color: var(--coding-color);
      color: #fff;
      border: none;
      padding: 8px 20px;
      font-weight: bold;
      border-radius: 6px;
      cursor: pointer;
      transition: opacity 0.3s ease;
      font-family: 'Poppins', sans-serif;
    }

    .run-button:hover {
      opacity: 0.85;
    }

    .console-output {
      width: 100%;
      height: 250px;
      background: #141414;
      color: #0f0;
      border: 2px solid var(--coding-color);
      border-radius: 8px;
      padding: 1rem;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    .error-text {
      color: #ff0000;
    }

    #side-tab {
      position: fixed;
      left: -120px;
      top: 40%;
      height: 60px;
      background-color: var(--coding-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-radius: 0 10px 10px 0;
      font-weight: bold;
      text-decoration: none;
      transition: left 0.4s ease;
      padding: 0 10px;
      width: 150px;
      z-index: 1000;
      cursor: pointer;
      color: #141414;
    }

    #side-tab:hover {
      left: 0;
      width: 180px;
    }

    #side-tab img {
      width: 50px;
      height: 50px;
      object-fit: contain;
      display: inline;
    }

    #side-tab span {
      display: inline;
      color: #141414;
    }

    #popup-button {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: url('images/favicons/favicon.enigma.png') center/cover;
      cursor: pointer;
      transition: background-color 0.18s ease, transform 0.12s ease;
      z-index: 2500;
      border: none;
      padding: 0;
    }

    #popup-button:hover {
      transform: scale(1.06);
      opacity: 0.9;
    }

    .popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--main-bg);
      border: 2px solid var(--coding-color);
      border-radius: 12px;
      width: 400px;
      max-height: 80vh;
      padding: 1.5rem;
      display: none;
      z-index: 3000;
      box-shadow: 0 10px 40px rgba(0,0,0,0.6);
      overflow-y: auto;
    }

    .popup h2 {
      color: var(--coding-color);
      margin-top: 0;
    }

    .popup-close-btn {
      background: var(--coding-color);
      border: none;
      color: #fff;
      border-radius: 6px;
      padding: 6px 12px;
      cursor: pointer;
      float: right;
    }

    .popup p {
      color: #fff;
      font-size: 0.95rem;
    }

    .popup input, .popup textarea {
      width: 100%;
      padding: 0.5rem;
      background: #141414;
      color: #fff;
      border: 2px solid var(--coding-color);
      border-radius: 6px;
      margin: 0.5rem 0;
      font-family: 'Courier New', monospace;
    }

    .popup button.add-btn {
      background: var(--coding-color);
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 0.5rem;
      font-family: 'Poppins', sans-serif;
    }

    .stack-display, .var-display {
      background: #141414;
      padding: 1rem;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      max-height: 400px;
      overflow-y: auto;
    }

    .stack-item {
      padding: 0.25rem;
      border-bottom: 1px solid #333;
    }

    #load-file-input {
      display: none;
    }

    .macro-delete {
      background: #D0021B;
      color: #fff;
      border: none;
      padding: 2px 6px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.65rem;
      float: right;
    }
  </style>
</head>
<body>
  <div class="side-panel left">
    <h3>Glyphs</h3>
    <div class="glyph-item" data-glyph="▲"><span class="glyph-char">▲</span>Push</div>
    <div class="glyph-item" data-glyph="▼"><span class="glyph-char">▼</span>Pop</div>
    <div class="glyph-item" data-glyph="⇅"><span class="glyph-char">⇅</span>Duplicate</div>
    <div class="glyph-item" data-glyph="↔"><span class="glyph-char">↔</span>Swap</div>
    <div class="glyph-item" data-glyph="↡"><span class="glyph-char">↡</span>Pop N</div>
    <div class="glyph-item" data-glyph="÷"><span class="glyph-char">÷</span>Divide</div>
    <div class="glyph-item" data-glyph="%"><span class="glyph-char">%</span>Modulo</div>
    <div class="glyph-item" data-glyph="¦"><span class="glyph-char">¦</span>Newline</div>
    <div class="glyph-item" data-glyph="∑"><span class="glyph-char">∑</span>Sigma</div>
    <div class="glyph-item" data-glyph="∞"><span class="glyph-char">∞</span>Infinity</div>
  </div>

  <div class="side-panel right">
    <h3>Macros</h3>
    <div id="macro-list"></div>
    <button class="add-macro-btn" id="add-macro-btn">+ Add Macro</button>
  </div>

  <header class="main-header">
    <img src="images/logos/logo.coding.png" alt="Blue Nexus Coding Logo" class="header-logo">
    <button class="back-button" id="back-btn">Back</button>
    <button class="save-button" id="save-btn">Save</button>
    <button class="load-button" id="load-btn">Load</button>
    <input type="file" id="load-file-input" accept=".bnx">
  </header>

  <a id="side-tab" href="https://knowledge.bluenexus.dev/knowledge-base/spec.pdf" target="_blank">
    <span>Spec</span>
    <img src="images/favicons/favicon.coding.png" alt="Spec Icon">
  </a>

  <main class="main-content">
    <div class="code-area" id="code-input"></div>

    <div class="console-section">
      <div class="console-header">
        <h3>Console</h3>
        <button class="run-button" id="run-btn">Run</button>
      </div>
      <div class="console-output" id="console-output"></div>
    </div>
  </main>

  <footer class="main-footer">
    <p>© 2025 Blue Nexus. All rights reserved.</p>
  </footer>

  <button id="popup-button"></button>

  <div class="popup" id="stack-popup">
    <button class="popup-close-btn">Close</button>
    <h2>Stack</h2>
    <div class="stack-display" id="stack-display"></div>
  </div>

  <div class="popup" id="var-popup">
    <button class="popup-close-btn">Close</button>
    <h2 id="var-popup-title">Variable</h2>
    <div class="var-display" id="var-display"></div>
  </div>

  <div class="popup" id="macro-popup">
    <button class="popup-close-btn">Close</button>
    <h2>Add Macro</h2>
    <p>Name:</p>
    <input type="text" id="macro-name" placeholder="Macro Name">
    <p>Code:</p>
    <textarea id="macro-code" rows="4" placeholder="BlueNexus code"></textarea>
    <button class="add-btn" id="save-macro-btn">Add Macro</button>
  </div>

  <script src="interpreter.js"></script>
  <script>
    let editor, interpreter;
    
    window.addEventListener('DOMContentLoaded', function() {
      editor = CodeMirror(document.getElementById('code-input'), {
        mode: 'text/plain',
        theme: 'monokai',
        lineNumbers: true,
        lineWrapping: true,
        autofocus: true,
        value: ''
      });

      const consoleOutput = document.getElementById('console-output');
      const macroList = document.getElementById('macro-list');
      const macroPopup = document.getElementById('macro-popup');
      const stackPopup = document.getElementById('stack-popup');
      const varPopup = document.getElementById('var-popup');
      
      interpreter = new BlueNexusInterpreter(consoleOutput, stackPopup, varPopup);
      
      document.getElementById('popup-button').addEventListener('click', function(e) {
        e.preventDefault();
        window.location.href = 'https://enigma.bluenexus.dev';
      });

      document.getElementById('back-btn').addEventListener('click', function(e) {
        e.preventDefault();
        window.history.back();
      });

      document.querySelectorAll('.popup-close-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
          stackPopup.style.display = 'none';
          varPopup.style.display = 'none';
          macroPopup.style.display = 'none';
        });
      });

      document.getElementById('save-btn').addEventListener('click', function(e) {
        e.preventDefault();
        const code = editor.getValue();
        const blob = new Blob([code], { type: 'text/plain' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'code.bnx';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(a.href);
      });

      document.getElementById('load-btn').addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('load-file-input').click();
      });

      document.getElementById('load-file-input').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(event) {
            editor.setValue(event.target.result);
          };
          reader.readAsText(file);
        }
      });

      document.querySelectorAll('.glyph-item').forEach(function(item) {
        item.addEventListener('click', function(e) {
          e.preventDefault();
          const glyph = this.getAttribute('data-glyph');
          editor.replaceSelection(glyph);
          editor.focus();
        });
      });

      let macros = [];

      function renderMacros() {
        macroList.innerHTML = '';
        macros.forEach(function(macro, index) {
          const div = document.createElement('div');
          div.className = 'macro-item';
          
          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'macro-delete';
          deleteBtn.textContent = '×';
          deleteBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            macros.splice(index, 1);
            renderMacros();
          });
          
          const nameSpan = document.createElement('strong');
          nameSpan.textContent = macro.name;
          
          div.appendChild(deleteBtn);
          div.appendChild(nameSpan);
          
          div.addEventListener('click', function(e) {
            e.preventDefault();
            editor.replaceSelection(macro.code);
            editor.focus();
          });
          
          macroList.appendChild(div);
        });
      }

      document.getElementById('add-macro-btn').addEventListener('click', function(e) {
        e.preventDefault();
        macroPopup.style.display = 'block';
      });

      document.getElementById('save-macro-btn').addEventListener('click', function(e) {
        e.preventDefault();
        const name = document.getElementById('macro-name').value.trim();
        const code = document.getElementById('macro-code').value.trim();
        if (name && code) {
          macros.push({ name: name, code: code });
          renderMacros();
          document.getElementById('macro-name').value = '';
          document.getElementById('macro-code').value = '';
          macroPopup.style.display = 'none';
        }
      });

      document.getElementById('run-btn').addEventListener('click', async function(e) {
        e.preventDefault();
        const code = editor.getValue();
        await interpreter.run(code);
      });
    });
  </script>
</body>
</html>